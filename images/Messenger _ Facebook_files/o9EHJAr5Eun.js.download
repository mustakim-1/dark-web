;/*FB_PKG_DELIM*/

__d("MAWQPLLogger",["QPLUserFlow","Random"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return{addQPLAnnotations:function(b,d){c("QPLUserFlow").addAnnotations(a,d,{instanceKey:b})},markQPLCancel:function(b){c("QPLUserFlow").endCancel(a,{instanceKey:b})},markQPLFailure:function(b,d){var e;c("QPLUserFlow").endFailure(a,(e=d==null?void 0:d.name)!=null?e:"fail",{error:d,instanceKey:b})},markQPLFailureWithMsg:function(b,d){c("QPLUserFlow").endFailure(a,d,{instanceKey:b})},markQPLPoint:function(b,d,e){c("QPLUserFlow").addPoint(a,d,{debugInfo:e,instanceKey:b})},markQPLStart:function(){var b=Date.now()+(Math.round(d("Random").random()*1e4)+1e4);c("QPLUserFlow").start(a,{instanceKey:b});return b},markQPLSuccess:function(b){c("QPLUserFlow").endSuccess(a,{instanceKey:b})}}}g["default"]=a}),98);
__d("MAWDataSourceLogger",["I64","MAWQPLLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){i==null&&(i=c("MAWQPLLogger")(c("qpl")._(25303796,"1974")));return i}function a(){return j().markQPLStart()}function b(a,b,c){j().markQPLPoint(a,"wait_act_thread_start","before fetching messages range from table"),j().addQPLAnnotations(a,{"int":{version:1},string:{direction:b,thread_id:(h||(h=d("I64"))).to_string(c)}})}function e(a,b){j().markQPLFailureWithMsg(a,b)}function f(a){j().markQPLCancel(a)}function k(a){j().markQPLPoint(a,"wait_act_thread_end","before fetching messages range from table"),j().markQPLPoint(a,"load_more_msgs_start","load more messages from MAW DB")}function l(a,b){j().markQPLPoint(a,"load_more_msgs_end","Note: OLD SOLUTION DOES NOT FETCH messages. they are fetched in afterTransaction that we cannot control"),j().addQPLAnnotations(a,{bool:{hasMoreBefore:b}})}function m(a){j().markQPLSuccess(a)}function n(a,b){j().markQPLPoint(a,"issued_range_query","MAWFetchSecureMessages: minMsgSortOrderTsResponse "+b)}function o(a,b){j().markQPLFailure(a,b)}g.logLoadMoreMsgsStart=a;g.logLoadMoreMsgsThreadWaiting=b;g.logLoadMoreMsgsFailure=e;g.logLoadMoreMsgsCancel=f;g.logLoadMoreMsgsThreadReadyFetchMsgs=k;g.logLoadMoreMsgsFetched=l;g.logLoadMoreMsgsSuccess=m;g.logLoadMoreMsgsRangeQuery=n;g.logLoadMoreMsgsRuntimeError=o}),98);
__d("MAWIsEBEnabled",["I64","LSEncryptedBackupsBackupTenancy","LSIntEnum","MAWEncryptedBackupUtils","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(!c("gkx")("23914"))return!1;a=(yield d("MAWEncryptedBackupUtils").getBackupTenancy(a.tables));return a!=null&&(h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION))});return j.apply(this,arguments)}g.isEbEnabled=a}),98);
__d("MAWPutMessagesToDB",["MAWBridgeDeleteReactionHandler","MAWBridgeMsgsStartCountdownHandler","MAWBridgeNewMediaHandler","MAWBridgeNewMsgHandler","MAWBridgeNewXMAHandler","MAWBridgeReactionUpsertHandler","Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){var e=c.expiringCountdown,f=c.medias,g=c.msgs,i=c.reactions;c=c.xmas;yield d("MAWBridgeNewMsgHandler").bulkCall(a,g);yield (h||(h=b("Promise"))).all(f.map(function(b){return d("MAWBridgeNewMediaHandler").call(a,b)}));yield h.all(c.map(function(b){return d("MAWBridgeNewXMAHandler").call(a,b)}));yield d("MAWBridgeMsgsStartCountdownHandler").call(a,{msgs:e});yield h.all(i.map(function(b){return b.type==="delete"?d("MAWBridgeDeleteReactionHandler").call(a,b.reaction):d("MAWBridgeReactionUpsertHandler").call(a,b.reaction)}))});return j.apply(this,arguments)}function a(a,b){return a.runInTransaction(function(a){return i(a,b)},"readwrite","ui",void 0,f.id+":54")}function c(a,b){return a.runInTransaction(function(a){return i(a,babelHelpers["extends"]({},b,{expiringCountdown:[],hasMoreAfter:!1,hasMoreBefore:!1}))},"readwrite","ui",void 0,f.id+":70")}g.insertMessageResponseToDBInExistingTransaction=i;g.insertMessageResponseIntoDatabase=a;g.insertMessageResponseIntoDatabaseByExternalId=c}),98);
__d("MAWSecureDataSource",[],(function(a,b,c,d,e,f){"use strict";a=10;f.DEFAULT_NUM_MESSAGES=a}),66);
__d("MAWSecureLocalDBFetch",["CometLruCache","I64","MAWBridgeSendAndReceive","MAWDbMsg","asyncToGeneratorRuntime","deepEquals"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("CometLruCache").create(20,2e3);function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.actionType,e=a.chatJid,f=a.config,g=a.count,j=a.direction,k=a.offsetMsg;a=a.timestampMs;var l=i.get(e);if(l!=null){var m=l&&l.options,n=m.count;m=babelHelpers.objectWithoutPropertiesLoose(m,["count"]);if(c("deepEquals")(m,{config:f,direction:j,offsetMsg:k,timestampMs:a})&&g<=n)return l.result}n=babelHelpers["extends"]({},yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","maw_load_msgs",{actionType:b,chatJid:e,config:f,direction:j,includeOriginalMsg:(m=k==null?void 0:k.includeOriginalMsg)!=null?m:!1,msgId:(k==null?void 0:k.messageId)==null?null:d("MAWDbMsg").toMsgId(k.messageId),numMsgs:g,sortOrderMs:a!=null?(h||(h=d("I64"))).to_float(a):null}));i.set(e,{options:{config:f,count:g,direction:j,offsetMsg:k,timestampMs:a},result:n});return n});return j.apply(this,arguments)}g["default"]=a}),98);
__d("MLV2DataSourceLogger",["I64","MAWQPLLogger","nullthrows","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){i==null&&(i=c("MAWQPLLogger")(c("qpl")._(25303796,"1974")));return i}var k=new Map();function l(a,b){return(h||(h=d("I64"))).to_string(a)+b}function a(a,b,d){var e=l(a,b);if(k.has(e))return c("nullthrows")(k.get(e));var f=j().markQPLStart(),g=new Set(),h={addQPLAnnotations:function(a){j().addQPLAnnotations(f,a)},annotateMessageRangesDataSource:function(a){g.add(a),j().addQPLAnnotations(f,{string_array:{message_ranges_source:Array.from(g.keys())}})},markQPLCancel:function(){j().markQPLCancel(f),k["delete"](e)},markQPLFailure:function(a){j().markQPLFailure(f,a),k["delete"](e)},markQPLFailureWithMsg:function(a){j().markQPLFailureWithMsg(f,a),k["delete"](e)},markQPLPoint:function(a){j().markQPLPoint(f,a)},markQPLSuccess:function(){j().markQPLSuccess(f),k["delete"](e)}};k.set(e,h);n(b,d,a);return h}function m(a,b){a=l(a,b);return k.get(a)}function n(a,b,c){var e;(e=m(c,a))==null?void 0:e.addQPLAnnotations({"int":{queried_count:b},string:{direction:a,thread_id:(h||(h=d("I64"))).to_string(c)}})}g.startMLV2LoggerForThread=a;g.getMLV2LoggerForThread=m}),98);
__d("MAWSecureLocalDBDataSource",["I64","MAWBridgeSendAndReceive","MAWDataSourceLogger","MAWDbMsg","MAWIsEBEnabled","MAWMiActOnActThreadReady","MAWPutMessagesToDB","MAWSecureDataSource","MAWSecureLocalDBFetch","MLV2DataSourceLogger","MWEncryptedBackUpEBNotEnabledError","Promise","ReQL","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","gkx","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch messages: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["useFetchSecureMessages: threadJid: "," threadId: "," minMsgSortOrderTsResponse ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetch more: ",""]);l=function(){return a};return a}var m=c("requireDeferred")("MAWEBFetch").__setRef("MAWSecureLocalDBDataSource"),n=d("WATagsLogger").TAGS(["MAWSecureLocalDBDataSource"]);a=function(){function a(){}var e=a.prototype;e.$1=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,j,o,p,q,r){if(o==="after")return;o;n.LOG(l(),e);d("MAWDataSourceLogger").logLoadMoreMsgsThreadWaiting(q,"before",e);o=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,e,"MAWFetchMoreMessages"));var s=o.chatId,t=o.chatJid;d("MAWDataSourceLogger").logLoadMoreMsgsThreadReadyFetchMsgs(q);if(c("gkx")("1560")){o=(yield d("MAWIsEBEnabled").isEbEnabled(a));yield o?m.load().then(function(b){return b({chatId:s,chatJid:t,count:p,db:a,direction:"before",timestampMs:g})}):(i||(i=b("Promise"))).resolve(d("WAResultOrError").makeError(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED))}var u=(yield c("MAWSecureLocalDBFetch")({actionType:r,chatJid:t,config:{editMsgHistory:!0,media:!0,reactions:!0,xma:!0},count:p,direction:"before",offsetMsg:{includeOriginalMsg:!1,messageId:j.minMessageId},timestampMs:g})),v=u.msgs.length>0?u.msgs[u.msgs.length-1].msgId:j.minMessageId;yield a.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c;yield d("MAWPutMessagesToDB").insertMessageResponseToDBInExistingTransaction(b,u);c=(yield (c=b.messages_ranges_v2__generated).get.apply(c,[j.threadKey,j.minTimestampMs,j.minMessageId]));if(c==null)return;var e=u.hasMoreBefore;u.hasMoreBefore===!1&&(yield d("MAWIsEBEnabled").isEbEnabled(a))&&(e=!0);yield b.messages_ranges_v2__generated.upsert([c.threadKey,c.minTimestampMs,c.minMessageId],{hasMoreAfter:!1,hasMoreBefore:e,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:c.maxMessageId,maxTimestampMs:c.maxTimestampMs,minMessageId:v,minTimestampMs:(h||(h=d("I64"))).zero,threadKey:j.threadKey})});return function(a){return c.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":117");d("MAWDataSourceLogger").logLoadMoreMsgsFetched(q,u.hasMoreBefore);if(u.hasMoreBefore){d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(q);return}o=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getMaybeNextNonAdminMsgSortOrderMs",{chatJid:t,mayBeAdminMsgId:d("MAWDbMsg").toMsgId(j.minMessageId)}));d("WATagsLogger").TAGS(["labyrinth_web","useFetchSecureMessages"]).LOG(k(),t,s,o.minMsgTimestampMs);d("MAWDataSourceLogger").logLoadMoreMsgsRangeQuery(q,o.minMsgTimestampMs);r=(yield m.load());r=(yield r({chatId:s,chatJid:t,count:p,db:a,direction:"before",timestampMs:(h||(h=d("I64"))).of_float(o.minMsgTimestampMs)}));r.success&&r.value.hasMoreBefore===!1&&(yield a.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c=j.minTimestampMs,f=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(e).bounds({lte:[c]}).filter(function(a){var b=a.maxTimestampMs;a=a.minTimestampMs;return(h||(h=d("I64"))).ge(c,a)&&(h||(h=d("I64"))).le(c,b)})));if(f==null)return;yield b.messages_ranges_v2__generated.upsert([f.threadKey,f.minTimestampMs,f.minMessageId],babelHelpers["extends"]({},f,{hasMoreBefore:!1,isLoadingBefore:!1}))});return function(a){return c.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":193"));d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(q)});function e(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}return e}();e.requestMessages=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,i,j){j=(yield c("MAWSecureLocalDBFetch")({actionType:j,chatJid:b,config:i,count:(a=h)!=null?a:d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES,direction:g,offsetMsg:f==null?null:{includeOriginalMsg:!1,messageId:f},timestampMs:e}));b=j.msgs.map(function(a){return{externalId:a.externalId,msgType:a.type_,sortOrderMs:a.sortOrderMs}});return{hasMoreAfter:j.hasMoreAfter,hasMoreBefore:j.hasMoreBefore,msgs:b}});function e(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}return e}();e.fetchSecureMessagesProtocol=function(a,b,c,e,f,g,h){g===void 0&&(g=d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES);var i=d("MAWDataSourceLogger").logLoadMoreMsgsStart();return this.$1(a,b,c,e,f,g,i,h)["catch"](function(a){var c;n.ERROR(j(),a);(c=d("MLV2DataSourceLogger").getMLV2LoggerForThread(b,f))==null?void 0:c.markQPLFailure(a)})};return a}();g["default"]=a}),98);
__d("MWPFetchMessagesThreadLocks",["FBLogger","I64"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){var e=(h||(h=d("I64"))).to_string(b);return{lock:{after:function(){var b=f();b.after===!0&&c("FBLogger")("messenger_web_product").mustfix("Locking threadLockStatus twice");b.after=!0;a.set(e,b)},before:function(){var b=f();b.before===!0&&c("FBLogger")("messenger_web_product").mustfix("Locking threadLockStatus twice");b.before=!0;a.set(e,b)}},release:{after:function(){var b=f();b.after=!1;a.set(e,b)},before:function(){var b=f();b.before=!1;a.set(e,b)}},state:f()};function f(){var b=a.get(e);b==null&&(b={after:!1,before:!1},a.set(e,b));return b}}g.localThreadStatus=a}),98);
__d("MWPFetchMessagesPageV2",["FBLogger","LSFactory","LSIntEnum","LSIssueMessagesRangeQueryStoredProcedure","LSMailboxMessagesRangeQueryDirection","LSMessagingThreadTypeUtil","MWPFetchMessagesThreadLocks","asyncToGeneratorRuntime","nullthrows","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,d,e,f,g,h){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,i,j){var k,m;k=(yield (k=a.tables.messages_ranges_v2__generated).get.apply(k,f));if(k==null)return;m=h&&(yield (m=a.tables.messages_ranges_v2__generated).get.apply(m,h));if(m==null&&h!=null)return;h=d("LSMessagingThreadTypeUtil").isArmadilloSecure(g);g=i!=null?d("LSMessagingThreadTypeUtil").isArmadilloSecure(i):!1;if(e==="before")if(k.hasMoreBefore)if(h)return l(a,b,e,k,j);else return n(a,f,k.threadKey,e);else if(m!=null)if(g)return l(a,b,e,m,j);else return n(a,[m.threadKey,m.minTimestampMs,m.minMessageId],m.threadKey,e);else return;else{e;if(k.hasMoreAfter)if(h)throw c("FBLogger")("messenger_web_product").mustfix("Not possible to fetch more after for secure messages");else return n(a,f,k.threadKey,e);else if(m!=null){g=d("LSMessagingThreadTypeUtil").isArmadilloSecure(c("nullthrows")(i));if(g)throw c("FBLogger")("messenger_web_product").mustfix("Not possible to fetch more after for secure messages");else return n(a,[m.threadKey,m.minTimestampMs,m.minMessageId],m.threadKey,e)}else return}});return i.apply(this,arguments)}var j=new Map(),k=new Map();function l(a,b,c,d,e){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g){if(c("qex")._("1215")!==!0){var h=d("MWPFetchMessagesThreadLocks").localThreadStatus(j,f.threadKey);if(h.state[e])return;try{h.lock[e]();var i=(yield a.tables.messages.index("messageId").get(f.minMessageId));return yield g.fetchSecureMessagesProtocol(a,f.threadKey,i==null?void 0:i.primarySortKey,f,e,b,"user")}finally{h.release[e]()}}});return m.apply(this,arguments)}function n(a,b,c,d){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,i){g=d("MWPFetchMessagesThreadLocks").localThreadStatus(k,g);if(g.state[i])return;try{g.lock[i]();return yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;b=(yield (b=a.messages_ranges_v2__generated).get.apply(b,e));if(!b)return;if(b.isLoadingBefore&&i==="before")return;if(b.isLoadingAfter&&i==="after")return;return c("LSIssueMessagesRangeQueryStoredProcedure")(c("LSFactory")(a),{direction:(h||(h=d("LSIntEnum"))).ofNumber(i==="before"?c("LSMailboxMessagesRangeQueryDirection").BEFORE:c("LSMailboxMessagesRangeQueryDirection").AFTER),referenceTimestampMs:b.minTimestampMs,threadKey:b.threadKey})});return function(b){return a.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":196")}finally{g.release[i]()}});return o.apply(this,arguments)}g["default"]=a}),98);
__d("MAWPreloadSecureMessages",["I64","LSIntEnum","MAWSecureLocalDBDataSource","MWPFetchMessagesPageV2","Promise","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=new(c("MAWSecureLocalDBDataSource"))();function a(a,b,c,d){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){var l=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(e)));e=l!=null?[e,l==null?void 0:l.minTimestampMs,l==null?void 0:l.minMessageId]:null;l=g!=null?yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(g)):null;g=l!=null?[l==null?void 0:l.threadKey,l==null?void 0:l.minTimestampMs,l==null?void 0:l.minMessageId]:null;l=(i||(i=d("I64"))).equal(f,(j||(j=d("LSIntEnum"))).ofNumber(15))?(j||(j=d("LSIntEnum"))).ofNumber(1):(j||(j=d("LSIntEnum"))).ofNumber(2);return e!=null?c("MWPFetchMessagesPageV2")(a,15,"before",e,f,g,l,k):(h||(h=b("Promise"))).resolve()});return l.apply(this,arguments)}g.preloadSecureMessages=a}),98);