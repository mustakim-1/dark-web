;/*FB_PKG_DELIM*/

__d("CometUnconnectedGamesOptedOutDialogQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="6992644354165796"}),null);
__d("MAWMessageIntegrityChecker",[],(function(a,b,c,d,e,f){"use strict";function g(a,b){if(a.externalId===b.externalId)return 0;if(a.sortOrderMs>b.sortOrderMs)return 1;return a.sortOrderMs<b.sortOrderMs?-1:-1}function a(a,b,c){var d=0,e=0,f=0,h=0,i=[],j=a.map(function(a){return a.externalId}),k=new Set(b.map(function(a){return a.externalId}));j=a.length===b.length&&j.every(function(a){return k.has(a)});if(j)b.forEach(function(a){return i.push([a,"consistent"])});else{while(d<a.length&&e<b.length){j=a[d];var l=b[e],m=g(j,l);m===0?(d+=1,e+=1,i.push([j,"consistent"])):m<0?(e+=1,f+=1,i.push([l,"missing_in_target"])):(d+=1,h+=1,i.push([j,"missing_in_reference"]))}while(b.length!==c&&d<a.length){m=a[d];d+=1;h+=1;i.push([m,"missing_in_reference"])}while(a.length!==c&&e<b.length){l=b[e];e+=1;f+=1;i.push([l,"missing_in_target"])}}if(f===0&&h===0)return{detailedResults:i,result:"consistent"};else if(f>0&&h===0)return{detailedResults:i,numOfMissingMessages:f,result:"missing_in_target"};else if(f===0&&h>0)return{detailedResults:i,numOfMissingMessages:h,result:"missing_in_reference"};else return{detailedResults:i,numOfMissingMessages:h+f,result:"missing_in_both"}}f.checkIntegrityforMessageList=a}),66);
__d("MAWMessageIntegrityCheck",["CometDebounce","I64","MAWBridgeSendAndReceive","MAWDbMsg","MAWEBFetch","MAWMessageIntegrityChecker","MAWMiActOnActThreadReady","MAWSecureLocalDBDataSource","Promise","ReQL","WATagsLogger","asyncToGeneratorRuntime","gkx","logMessengerWebFalcoEvent","promiseDone","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing message detected for ",", result: ",", num of messages missing: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", result against EB data: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", result against backend data: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check skipped for threadKey: ",", lastItem: ",", reason: EB result not available"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["run Message Integrity Check - threadKey: ",", lastItem: ",", pageSize: ",""]);n=function(){return a};return a}var o="3",p=d("WATagsLogger").TAGS(["MissingMessages"]),q=new(c("MAWSecureLocalDBDataSource"))(),r=c("CometDebounce")(c("logMessengerWebFalcoEvent"));function s(a,b,c,d){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){b=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,b,"MAWFetchMessagesFromBackend"));b=b.chatJid;a=(yield q.requestMessages(a,b,c!=null?c.primarySortKey:null,c==null?void 0:c.messageId,"before",e,{editMsgHistory:!1,media:!1,reactions:!1,xma:!1},"integrity"));return a.msgs});return t.apply(this,arguments)}function u(a,b,c,d){return v.apply(this,arguments)}function v(){v=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){e=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,e,"MAWFetchMessagesFromBackend"));e=e.chatJid;var j=f==null?null:d("MAWDbMsg").toMsgId(f.messageId);j=(yield j==null?(i||(i=b("Promise"))).resolve(null):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:j}));var k=(j=j==null?void 0:j.externalId)!=null?j:f==null?void 0:f.offlineThreadingId,l=f==null?void 0:f.primarySortKey;j=(yield c("MAWEBFetch")({chatJid:e,count:g,db:a,direction:"before",skipFullRestore:!0,timestampMs:l}));return j.success===!0?j.value.messages.map(function(a){var b;return{externalId:a.xOfflineThreadingId,msgType:String((b=a.xContentType)!=null?b:"unknown_eb_msg_type"),sortOrderMs:a.sortOrderMs}}).reverse().filter(function(a){return l==null||!(h||(h=d("I64"))).equal(l,(h||(h=d("I64"))).of_float(a.sortOrderMs))||a.externalId!==k}):null});return v.apply(this,arguments)}function w(a,b){if(a.sortOrderMs===b.sortOrderMs){var c;return((c=a.externalId)!=null?c:"").localeCompare((c=b.externalId)!=null?c:"")}return b.sortOrderMs-a.sortOrderMs}function x(a){return{externalId:a.offlineThreadingId,msgType:(h||(h=d("I64"))).to_string(a.displayedContentTypes),sortOrderMs:h.to_float(a.primarySortKey)}}function y(a){return babelHelpers["extends"]({},a)}function z(a){var c=function(a){var c=d("MAWDbMsg").toMsgId(a.messageId);return c==null?(i||(i=b("Promise"))).resolve(a):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:c}).then(function(b){return babelHelpers["extends"]({},a,{offlineThreadingId:(b=b==null?void 0:b.externalId)!=null?b:a.offlineThreadingId})})};return(i||(i=b("Promise"))).all(a.map(c))}function A(a,b){return B.apply(this,arguments)}function B(){B=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){a=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.messages_ranges_v2__generated).getKeyRange(c)));if(a.length===0)return(i||(i=b("Promise"))).resolve("Messages range is missing");var e=function(a){a=d("MAWDbMsg").toMsgId(a);return a==null?(i||(i=b("Promise"))).resolve(null):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:a}).then(function(a){return a==null?void 0:a.externalId})};c=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=(yield (i||(i=b("Promise"))).all([e(a.maxMessageId),e(a.minMessageId)])),d=c[0];c=c[1];return babelHelpers["extends"]({},a,{maxMessageId:(d=d)!=null?d:a.maxMessageId,minMessageId:(d=c)!=null?d:a.minMessageId})});return function(b){return a.apply(this,arguments)}}();a=(yield (i||(i=b("Promise"))).all(a.map(c)));return i.resolve(JSON.stringify(a.map(function(a){return{hasMoreAfter:a.hasMoreAfter,hasMoreBefore:a.hasMoreBefore,maxMessageId:a.maxMessageId,maxTimestampMs:(h||(h=d("I64"))).to_string(a.maxTimestampMs),minMessageId:a.minMessageId,minTimestampMs:h.to_string(a.minTimestampMs)}})))});return B.apply(this,arguments)}function a(a,e,f,g,q,t,v,B){p.LOG(n(),(h||(h=d("I64"))).to_float(e),t==null?"null":(h||(h=d("I64"))).to_float(t.primarySortKey),q);var F=c("gkx")("1626");c("promiseDone")((i||(i=b("Promise"))).all([z(v),s(a,e,t,q),u(a,e,t,q),F?A(a,e):(i||(i=b("Promise"))).resolve(null)]),function(a){var b=a[0],i=a[1],n=a[2];a=a[3];if(n==null){p.LOG(m(),(h||(h=d("I64"))).to_float(e),t==null?"null":(h||(h=d("I64"))).to_float(t.primarySortKey));return}i=i.map(function(a){return y(a)}).sort(w).slice(0,q);n=n.map(function(a){return y(a)}).sort(w).slice(0,q);b=b.map(function(a){return x(a)}).sort(w);var s=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(b,i,q);b=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(b,n,q);i=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(i,n,q);p.LOG(l(),(h||(h=d("I64"))).to_float(e),t==null?"null":(h||(h=d("I64"))).to_float(t.primarySortKey),JSON.stringify(s));p.LOG(k(),h.to_float(e),t==null?"null":(h||(h=d("I64"))).to_float(t.primarySortKey),JSON.stringify(b));b.result!=="consistent"&&p.WARN(j(),(h||(h=d("I64"))).to_float(e),b.result,b.numOfMissingMessages);n=E(i);i=E(b);b=E(s);s=D();var u=s.isNewestMsgIdCacheBypassed,v=s.isNewestMsgTsCacheBypassed;s=s.isOldestMsgIdCacheBypassed;r({threadKey:e,threadType:f},"message_integrity_check",g,{MAW_vs_EB_detailedResults:n.detailedResults,MAW_vs_EB_numOfMissingInReference:n.numOfMissingInReference,MAW_vs_EB_numOfMissingInTarget:n.numOfMissingInTarget,UI_vs_EB_detailedResults:i.detailedResults,UI_vs_EB_numOfMissingInReference:i.numOfMissingInReference,UI_vs_EB_numOfMissingInTarget:i.numOfMissingInTarget,UI_vs_MAW_detailedResults:b.detailedResults,UI_vs_MAW_numOfMissingInReference:b.numOfMissingInReference,UI_vs_MAW_numOfMissingInTarget:b.numOfMissingInTarget,enableOptimisticTimestampForSortKey:C(c("qex")._("939")===!0),hasAdditionalData:C(F),isAgnosticDataSourceOnOldMessageList:C(c("gkx")("2124")),isEBFetchesOnLoadMore:c("gkx")("1560")?"1":"0",isNewestMsgIdCacheBypassed:u,isNewestMsgTsCacheBypassed:v,isOldestMsgIdCacheBypassed:s,messagesRanges:(n=a)!=null?n:"null",pageIndex:B+"",pageSize:q+"",version:o})})}function C(a){return a===!0?"true":"false"}function D(){return{isNewestMsgIdCacheBypassed:C(c("qex")._("961")===!0),isNewestMsgTsCacheBypassed:C(c("qex")._("962")===!0),isOldestMsgIdCacheBypassed:C(c("qex")._("1005")===!0)}}function E(a){var b=a.detailedResults.filter(function(a){a[0];a=a[1];return a==="missing_in_target"}).length,c=a.detailedResults.filter(function(a){a[0];a=a[1];return a==="missing_in_reference"}).length;return{detailedResults:F(a.detailedResults),numOfMissingInReference:c+"",numOfMissingInTarget:b+""}}function F(a){a=a.map(function(a){var b=a[0];a=a[1];return babelHelpers["extends"]({externalId:b.externalId},c("gkx")("1626")?{msgType:b.msgType,sortOrderMs:b.sortOrderMs}:{},{result:a})});return JSON.stringify(a)}e={runMessageIntegrityCheck:a};g["default"]=e}),98);